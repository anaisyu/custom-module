import { computed, Inject, Injectable } from '@angular/core';
import { BehaviorSubject, of } from "rxjs";
import { TranslateHttpLoader } from "@ngx-translate/http-loader";
import * as i0 from "@angular/core";
import * as i1 from "@ngx-translate/core";
import * as i2 from "../notifications/notification.service";
import * as i3 from "@angular/common/http";
import * as i4 from "../local-storage/local-storage.service";
export class TranslationClientService {
    static { this.COOKIE_NAME = "site-text"; }
    constructor(service, notificationService, http, localStorageService, backendUrl) {
        this.service = service;
        this.notificationService = notificationService;
        this.http = http;
        this.localStorageService = localStorageService;
        this.backendUrl = backendUrl;
        this.editSubject = new BehaviorSubject(false);
        // Retrieve object from the cookie
        const objFromCookie = localStorageService.getValue(TranslationClientService.COOKIE_NAME);
        this.changes = computed(() => objFromCookie() ? JSON.parse(objFromCookie()) : {});
    }
    static merge(left, right) {
        if (typeof left !== 'object') {
            return right;
        }
        let res = Object.assign({}, left);
        for (const key of Object.keys(right)) {
            if (left[key]) {
                res[key] = this.merge(left[key], right[key]);
            }
            else {
                res[key] = right[key];
            }
        }
        return res;
    }
    next(key, data) {
        let set = this.changes();
        const keys = key.split('.');
        for (let i = 0; i < keys.length - 1; i++) {
            if (!set[keys[i]]) {
                set[keys[i]] = {};
            }
            set = set[keys[i]];
        }
        if (!set[keys[keys.length - 1]]) {
            set[keys[keys.length - 1]] = {};
        }
        set[keys[keys.length - 1]] = data;
        this.saveCookie();
    }
    save(lang = 'fr') {
        const loader = new TranslateHttpLoader(this.http, this.backendUrl + '/assets/get/');
        loader.getTranslation(lang).subscribe(original => {
            this.http.post(this.backendUrl + '/assets/save-new/' + lang, TranslationClientService.merge(original, this.changes())).subscribe({
                next: response => {
                    this.notificationService.newMessage('Vos modifications ont bien été sauvegardées.');
                    this.localStorageService.setValue(TranslationClientService.COOKIE_NAME, null);
                }, error: (msg) => {
                    console.error(msg);
                    this.notificationService.newError('Echec lors de la sauvegarde. Merci de réessayer.');
                }
            });
        });
    }
    cancel() {
        this.localStorageService.setValue(TranslationClientService.COOKIE_NAME, null);
        this.refresh();
    }
    refresh() {
        window.location.href = window.location.toString();
    }
    saveCookie(minutesExpire = 15) {
        if (!this.changes() || Object.keys(this.changes()).length == 0) {
            return;
        }
        const date = new Date(Date.now());
        date.setMinutes(date.getMinutes() + minutesExpire);
        this.localStorageService.setValue(TranslationClientService.COOKIE_NAME, JSON.stringify(this.changes()), minutesExpire * 60 * 1000);
    }
    streamTranslation(key) {
        let set = this.changes();
        const keys = key.split('.');
        for (let i = 0; i < keys.length - 1; i++) {
            if (!set[keys[i]]) {
                return this.service.stream(key);
            }
            set = set[keys[i]];
        }
        if (set[keys[keys.length - 1]]) {
            return of(set[keys[keys.length - 1]]);
        }
        return this.service.stream(key);
    }
    sync(lang = 'fr') {
        this.http.post(this.backendUrl + '/assets/sync/' + lang, {}).subscribe({
            next: response => {
                this.notificationService.newMessage('Synced');
            }, error: (msg) => {
                console.error(msg);
                this.notificationService.newError('Sync failed');
            }
        });
    }
    static { this.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "17.3.10", ngImport: i0, type: TranslationClientService, deps: [{ token: i1.TranslateService }, { token: i2.NotificationService }, { token: i3.HttpClient }, { token: i4.LocalStorageService }, { token: 'backendUrl' }], target: i0.ɵɵFactoryTarget.Injectable }); }
    static { this.ɵprov = i0.ɵɵngDeclareInjectable({ minVersion: "12.0.0", version: "17.3.10", ngImport: i0, type: TranslationClientService, providedIn: 'root' }); }
}
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "17.3.10", ngImport: i0, type: TranslationClientService, decorators: [{
            type: Injectable,
            args: [{
                    providedIn: 'root'
                }]
        }], ctorParameters: () => [{ type: i1.TranslateService }, { type: i2.NotificationService }, { type: i3.HttpClient }, { type: i4.LocalStorageService }, { type: undefined, decorators: [{
                    type: Inject,
                    args: ['backendUrl']
                }] }] });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidHJhbnNsYXRpb24tY2xpZW50LnNlcnZpY2UuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi8uLi9wcm9qZWN0cy9jdXN0b20tZGlzcGxheS9zcmMvbGliL3NlcnZpY2UvdHJhbnNsYXRlL3RyYW5zbGF0aW9uLWNsaWVudC5zZXJ2aWNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBQyxRQUFRLEVBQUUsTUFBTSxFQUFFLFVBQVUsRUFBaUIsTUFBTSxlQUFlLENBQUM7QUFHM0UsT0FBTyxFQUFDLGVBQWUsRUFBYyxFQUFFLEVBQUMsTUFBTSxNQUFNLENBQUM7QUFFckQsT0FBTyxFQUFDLG1CQUFtQixFQUFDLE1BQU0sNEJBQTRCLENBQUM7Ozs7OztBQU0vRCxNQUFNLE9BQU8sd0JBQXdCO2FBR1osZ0JBQVcsR0FBRyxXQUFXLEFBQWQsQ0FBYztJQUVoRCxZQUNVLE9BQXlCLEVBQ3pCLG1CQUF3QyxFQUN4QyxJQUFnQixFQUNoQixtQkFBd0MsRUFDbEIsVUFBa0I7UUFKeEMsWUFBTyxHQUFQLE9BQU8sQ0FBa0I7UUFDekIsd0JBQW1CLEdBQW5CLG1CQUFtQixDQUFxQjtRQUN4QyxTQUFJLEdBQUosSUFBSSxDQUFZO1FBQ2hCLHdCQUFtQixHQUFuQixtQkFBbUIsQ0FBcUI7UUFDbEIsZUFBVSxHQUFWLFVBQVUsQ0FBUTtRQVIzQyxnQkFBVyxHQUE2QixJQUFJLGVBQWUsQ0FBVSxLQUFLLENBQUMsQ0FBQztRQVVqRixrQ0FBa0M7UUFDbEMsTUFBTSxhQUFhLEdBQUcsbUJBQW1CLENBQUMsUUFBUSxDQUFDLHdCQUF3QixDQUFDLFdBQVcsQ0FBQyxDQUFDO1FBQ3pGLElBQUksQ0FBQyxPQUFPLEdBQUcsUUFBUSxDQUFDLEdBQUcsRUFBRSxDQUFDLGFBQWEsRUFBRSxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLGFBQWEsRUFBRyxDQUFDLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFB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LHdCQUF3QjtrQkFIcEMsVUFBVTttQkFBQztvQkFDVixVQUFVLEVBQUUsTUFBTTtpQkFDbkI7OzBCQVdJLE1BQU07MkJBQUMsWUFBWSIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7Y29tcHV0ZWQsIEluamVjdCwgSW5qZWN0YWJsZSwgc2lnbmFsLCBTaWduYWx9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHtUcmFuc2xhdGVTZXJ2aWNlfSBmcm9tIFwiQG5neC10cmFuc2xhdGUvY29yZVwiO1xuaW1wb3J0IHtIdHRwQ2xpZW50fSBmcm9tIFwiQGFuZ3VsYXIvY29tbW9uL2h0dHBcIjtcbmltcG9ydCB7QmVoYXZpb3JTdWJqZWN0LCBPYnNlcnZhYmxlLCBvZn0gZnJvbSBcInJ4anNcIjtcbmltcG9ydCB7Tm90aWZpY2F0aW9uU2VydmljZX0gZnJvbSBcIi4uL25vdGlmaWNhdGlvbnMvbm90aWZpY2F0aW9uLnNlcnZpY2VcIjtcbmltcG9ydCB7VHJhbnNsYXRlSHR0cExvYWRlcn0gZnJvbSBcIkBuZ3gtdHJhbnNsYXRlL2h0dHAtbG9hZGVyXCI7XG5pbXBvcnQge0xvY2FsU3RvcmFnZVNlcnZpY2V9IGZyb20gXCIuLi9sb2NhbC1zdG9yYWdlL2xvY2FsLXN0b3JhZ2Uuc2VydmljZVwiO1xuXG5ASW5qZWN0YWJsZSh7XG4gIHByb3ZpZGVkSW46ICdyb290J1xufSlcbmV4cG9ydCBjbGFzcyBUcmFuc2xhdGlvbkNsaWVudFNlcnZpY2Uge1xuICBwdWJsaWMgcmVhZG9ubHkgY2hhbmdlczogU2lnbmFsPE9iamVjdD47XG4gIHB1YmxpYyBlZGl0U3ViamVjdDogQmVoYXZpb3JTdWJqZWN0PGJvb2xlYW4+ID0gbmV3IEJlaGF2aW9yU3ViamVjdDxib29sZWFuPihmYWxzZSk7XG4gIHB1YmxpYyBzdGF0aWMgcmVhZG9ubHkgQ09PS0lFX05BTUUgPSBcInNpdGUtdGV4dFwiXG5cbiAgY29uc3RydWN0b3IoXG4gICAgcHJpdmF0ZSBzZXJ2aWNlOiBUcmFuc2xhdGVTZXJ2aWNlLFxuICAgIHByaXZhdGUgbm90aWZpY2F0aW9uU2VydmljZTogTm90aWZpY2F0aW9uU2VydmljZSxcbiAgICBwcml2YXRlIGh0dHA6IEh0dHBDbGllbnQsXG4gICAgcHJpdmF0ZSBsb2NhbFN0b3JhZ2VTZXJ2aWNlOiBMb2NhbFN0b3JhZ2VTZXJ2aWNlLFxuICAgIEBJbmplY3QoJ2JhY2tlbmRVcmwnKSBwcml2YXRlIGJhY2tlbmRVcmw6IHN0cmluZyxcbiAgICApIHtcbiAgICAvLyBSZXRyaWV2ZSBvYmplY3QgZnJvbSB0aGUgY29va2llXG4gICAgY29uc3Qgb2JqRnJvbUNvb2tpZSA9IGxvY2FsU3RvcmFnZVNlcnZpY2UuZ2V0VmFsdWUoVHJhbnNsYXRpb25DbGllbnRTZXJ2aWNlLkNPT0tJRV9OQU1FKTtcbiAgICB0aGlzLmNoYW5nZXMgPSBjb21wdXRlZCgoKSA9PiBvYmpGcm9tQ29va2llKCkgPyBKU09OLnBhcnNlKG9iakZyb21Db29raWUoKSEpIDoge30pXG4gIH1cblxuICBwdWJsaWMgc3RhdGljIG1lcmdlKGxlZnQ6IGFueSwgcmlnaHQ6IGFueSkge1xuICAgIGlmICh0eXBlb2YgbGVmdCAhPT0gJ29iamVjdCcpIHtcbiAgICAgIHJldHVybiByaWdodDtcbiAgICB9XG4gICAgbGV0IHJlcyA9IE9iamVjdC5hc3NpZ24oe30sIGxlZnQpO1xuICAgIGZvciAoY29uc3Qga2V5IG9mIE9iamVjdC5rZXlzKHJpZ2h0KSkge1xuICAgICAgaWYgKGxlZnRba2V5XSkge1xuICAgICAgICByZXNba2V5XSA9IHRoaXMubWVyZ2UobGVmdFtrZXldLCByaWdodFtrZXldKVxuICAgICAgfSBlbHNlIHtcbiAgICAgICAgcmVzW2tleV0gPSByaWdodFtrZXldXG4gICAgICB9XG4gICAgfVxuICAgIHJldHVybiByZXM7XG4gIH1cblxuICBuZXh0KGtleTogc3RyaW5nLCBkYXRhOiBzdHJpbmcpIHtcbiAgICBsZXQgc2V0OiBhbnkgPSB0aGlzLmNoYW5nZXMoKTtcblxuICAgIGNvbnN0IGtleXM6IHN0cmluZ1tdID0ga2V5LnNwbGl0KCcuJylcbiAgICBmb3IgKGxldCBpID0gMDsgaSA8IGtleXMubGVuZ3RoIC0gMTsgaSsrKSB7XG4gICAgICBpZiAoIXNldFtrZXlzW2ldXSkge1xuICAgICAgICBzZXRba2V5c1tpXV0gPSB7fVxuICAgICAgfVxuICAgICAgc2V0ID0gc2V0W2tleXNbaV1dXG4gICAgfVxuICAgIGlmICghc2V0W2tleXNba2V5cy5sZW5ndGggLSAxXV0pIHtcbiAgICAgIHNldFtrZXlzW2tleXMubGVuZ3RoIC0gMV1dID0ge31cbiAgICB9XG4gICAgc2V0W2tleXNba2V5cy5sZW5ndGggLSAxXV0gPSBkYXRhO1xuXG4gICAgdGhpcy5zYXZlQ29va2llKCk7XG4gIH1cblxuICBzYXZlKGxhbmc6IHN0cmluZyA9ICdmcicpIHtcbiAgICBjb25zdCBsb2FkZXIgPSBuZXcgVHJhbnNsYXRlSHR0cExvYWRlcih0aGlzLmh0dHAsIHRoaXMuYmFja2VuZFVybCArICcvYXNzZXRzL2dldC8nKVxuICAgIGxvYWRlci5nZXRUcmFuc2xhdGlvbihsYW5nKS5zdWJzY3JpYmUob3JpZ2luYWwgPT4ge1xuICAgICAgdGhpcy5odHRwLnBvc3QodGhpcy5iYWNrZW5kVXJsICsgJy9hc3NldHMvc2F2ZS1uZXcvJyArIGxhbmcsXG4gICAgICAgIFRyYW5zbGF0aW9uQ2xpZW50U2VydmljZS5tZXJnZShvcmlnaW5hbCwgdGhpcy5jaGFuZ2VzKCkpXG4gICAgICApLnN1YnNjcmliZSh7XG4gICAgICAgIG5leHQ6IHJlc3BvbnNlID0+IHtcbiAgICAgICAgICB0aGlzLm5vdGlmaWNhdGlvblNlcnZpY2UubmV3TWVzc2FnZSgnVm9zIG1vZGlmaWNhdGlvbnMgb250IGJpZW4gw6l0w6kgc2F1dmVnYXJkw6llcy4nKTtcbiAgICAgICAgICB0aGlzLmxvY2FsU3RvcmFnZVNlcnZpY2Uuc2V0VmFsdWUoVHJhbnNsYXRpb25DbGllbnRTZXJ2aWNlLkNPT0tJRV9OQU1FLCBudWxsKVxuICAgICAgICB9LCBlcnJvcjogKG1zZykgPT4ge1xuICAgICAgICAgIGNvbnNvbGUuZXJyb3IobXNnKVxuICAgICAgICAgIHRoaXMubm90aWZpY2F0aW9uU2VydmljZS5uZXdFcnJvcignRWNoZWMgbG9ycyBkZSBsYSBzYXV2ZWdhcmRlLiBNZXJjaSBkZSByw6llc3NheWVyLicpXG4gICAgICAgIH1cbiAgICAgIH0pXG4gICAgfSlcbiAgfVxuXG4gIGNhbmNlbCgpIHtcbiAgICB0aGlzLmxvY2FsU3RvcmFnZVNlcnZpY2Uuc2V0VmFsdWUoVHJhbnNsYXRpb25DbGllbnRTZXJ2aWNlLkNPT0tJRV9OQU1FLCBudWxsKVxuICAgIHRoaXMucmVmcmVzaCgpO1xuICB9XG5cbiAgcHJpdmF0ZSByZWZyZXNoKCkge1xuICAgIHdpbmRvdy5sb2NhdGlvbi5ocmVmID0gd2luZG93LmxvY2F0aW9uLnRvU3RyaW5nKClcbiAgfVxuXG4gIHNhdmVDb29raWUobWludXRlc0V4cGlyZTogbnVtYmVyID0gMTUpIHtcbiAgICBpZiAoIXRoaXMuY2hhbmdlcygpIHx8IE9iamVjdC5rZXlzKHRoaXMuY2hhbmdlcygpKS5sZW5ndGggPT0gMCkge1xuICAgICAgcmV0dXJuXG4gICAgfVxuICAgIGNvbnN0IGRhdGUgPSBuZXcgRGF0ZShEYXRlLm5vdygpKTtcbiAgICBkYXRlLnNldE1pbnV0ZXMoZGF0ZS5nZXRNaW51dGVzKCkgKyBtaW51dGVzRXhwaXJlKVxuICAgIHRoaXMubG9jYWxTdG9yYWdlU2VydmljZS5zZXRWYWx1ZShUcmFuc2xhdGlvbkNsaWVudFNlcnZpY2UuQ09PS0lFX05BTUUsXG4gICAgICBKU09OLnN0cmluZ2lmeSh0aGlzLmNoYW5nZXMoKSksXG4gICAgICBtaW51dGVzRXhwaXJlICogNjAgKiAxMDAwKVxuICB9XG5cbiAgc3RyZWFtVHJhbnNsYXRpb24oa2V5OiBzdHJpbmcpOiBPYnNlcnZhYmxlPHN0cmluZz4ge1xuICAgIGxldCBzZXQ6IGFueSA9IHRoaXMuY2hhbmdlcygpO1xuXG4gICAgY29uc3Qga2V5czogc3RyaW5nW10gPSBrZXkuc3BsaXQoJy4nKVxuICAgIGZvciAobGV0IGkgPSAwOyBpIDwga2V5cy5sZW5ndGggLSAxOyBpKyspIHtcbiAgICAgIGlmICghc2V0W2tleXNbaV1dKSB7XG4gICAgICAgIHJldHVybiB0aGlzLnNlcnZpY2Uuc3RyZWFtKGtleSlcbiAgICAgIH1cbiAgICAgIHNldCA9IHNldFtrZXlzW2ldXVxuICAgIH1cbiAgICBpZiAoc2V0W2tleXNba2V5cy5sZW5ndGggLSAxXV0pIHtcbiAgICAgIHJldHVybiBvZihzZXRba2V5c1trZXlzLmxlbmd0aCAtIDFdXSBhcyBzdHJpbmcpXG4gICAgfVxuXG4gICAgcmV0dXJuIHRoaXMuc2VydmljZS5zdHJlYW0oa2V5KTtcbiAgfVxuXG4gIHN5bmMobGFuZzogc3RyaW5nID0gJ2ZyJykge1xuICAgICAgdGhpcy5odHRwLnBvc3QodGhpcy5iYWNrZW5kVXJsICsgJy9hc3NldHMvc3luYy8nICsgbGFuZywge30pLnN1YnNjcmliZSh7XG4gICAgICBuZXh0OiByZXNwb25zZSA9PiB7XG4gICAgICAgIHRoaXMubm90aWZpY2F0aW9uU2VydmljZS5uZXdNZXNzYWdlKCdTeW5jZWQnKTtcbiAgICAgIH0sIGVycm9yOiAobXNnKSA9PiB7XG4gICAgICAgIGNvbnNvbGUuZXJyb3IobXNnKVxuICAgICAgICB0aGlzLm5vdGlmaWNhdGlvblNlcnZpY2UubmV3RXJyb3IoJ1N5bmMgZmFpbGVkJylcbiAgICAgIH1cbiAgICB9KVxuICB9XG59XG4iXX0=