import { Component, computed, HostListener, input, signal } from '@angular/core';
import { zip } from "rxjs";
import { DyImgComponent } from "../tag/dy-img/dy-img.component";
import * as i0 from "@angular/core";
import * as i1 from "../../../service/translate/translation-client.service";
import * as i2 from "../../../service/image-upload/image-upload.service";
export class DyPictureComponent {
    constructor(clientService, imageUploadService) {
        this.clientService = clientService;
        this.imageUploadService = imageUploadService;
        this.originalSrc = input.required();
        this.originalAlt = input.required();
        this.key = input.required();
        this.imgClass = input('');
        this.lazy = input(false);
        this.proportion = input(100);
        this.storedImage = signal(undefined);
        this.imageToDisplay = computed(() => {
            return this.storedImage() ?? { originalUrl: this.originalSrc(), thumbnailUrl: this.originalSrc(), compressedUrls: [] };
        });
        this.storedAlt = signal(undefined);
        this.altToDisplay = computed(() => {
            return this.storedAlt() ?? this.originalAlt();
        });
        this.editMode = signal(false);
    }
    ngAfterViewInit() {
        this.clientService.editSubject.subscribe(editMode => {
            this.editMode.set(editMode);
        });
    }
    onKeyup() {
        if (this.editMode()) {
            this.imageUploadService.openDialog().subscribe(res => {
                this.changeImage(res.urls, res.alt);
                this.save(res.urls, res.alt);
            });
        }
    }
    save(response, alt) {
        if (response && alt) {
            this.clientService.next('images.' + this.key() + '.originalUrl', response.originalUrl);
            this.clientService.next('images.' + this.key() + '.thumbnailUrl', response.thumbnailUrl);
            response.compressedUrls.forEach((compressedUrl, index) => {
                this.clientService.next('images.' + this.key() + '.compressed-' + index + '.url', compressedUrl.url);
                this.clientService.next('images.' + this.key() + '.compressed-' + index + '.height', compressedUrl.height);
                this.clientService.next('images.' + this.key() + '.compressed-' + index + '.width', compressedUrl.width);
            });
            this.clientService.next('images.' + this.key() + '.alt', alt);
        }
    }
    ngOnInit() {
        const urlKey = 'images.' + this.key() + '.originalUrl';
        const altKey = 'images.' + this.key() + '.alt';
        const key1$ = this.clientService.streamTranslation(urlKey);
        const key2$ = this.clientService.streamTranslation(altKey);
        /* *** IMPORTANT here is the number of different image compress size returned by backend (5): "400", "600", "800", "1000", "1200" *** */
        const keyUrl0$ = this.clientService.streamTranslation('images.' + this.key() + '.compressed-0.url');
        const keyHeight0$ = this.clientService.streamTranslation('images.' + this.key() + '.compressed-0.height');
        const keyWidth0$ = this.clientService.streamTranslation('images.' + this.key() + '.compressed-0.width');
        const keyUrl1$ = this.clientService.streamTranslation('images.' + this.key() + '.compressed-1.url');
        const keyHeight1$ = this.clientService.streamTranslation('images.' + this.key() + '.compressed-1.height');
        const keyWidth1$ = this.clientService.streamTranslation('images.' + this.key() + '.compressed-1.width');
        const keyUrl2$ = this.clientService.streamTranslation('images.' + this.key() + '.compressed-2.url');
        const keyHeight2$ = this.clientService.streamTranslation('images.' + this.key() + '.compressed-2.height');
        const keyWidth2$ = this.clientService.streamTranslation('images.' + this.key() + '.compressed-2.width');
        const keyUrl3$ = this.clientService.streamTranslation('images.' + this.key() + '.compressed-3.url');
        const keyHeight3$ = this.clientService.streamTranslation('images.' + this.key() + '.compressed-3.height');
        const keyWidth3$ = this.clientService.streamTranslation('images.' + this.key() + '.compressed-3.width');
        const keyUrl4$ = this.clientService.streamTranslation('images.' + this.key() + '.compressed-4.url');
        const keyHeight4$ = this.clientService.streamTranslation('images.' + this.key() + '.compressed-4.height');
        const keyWidth4$ = this.clientService.streamTranslation('images.' + this.key() + '.compressed-4.width');
        zip([
            key1$, key2$,
            keyUrl0$, keyHeight0$, keyWidth0$, keyUrl1$, keyHeight1$, keyWidth1$, keyUrl2$, keyHeight2$, keyWidth2$, keyUrl3$, keyHeight3$, keyWidth3$, keyUrl4$, keyHeight4$, keyWidth4$
        ]).subscribe(([url, alt, keyUrl0, keyHeight0, keyWidth0, keyUrl1, keyHeight1, keyWidth1, keyUrl2, keyHeight2, keyWidth2, keyUrl3, keyHeight3, keyWidth3, keyUrl4, keyHeight4, keyWidth4]) => {
            if (urlKey != url || altKey != alt) {
                const image = {
                    originalUrl: url, thumbnailUrl: url, compressedUrls: [
                        { url: keyUrl0, width: keyWidth0, height: keyHeight0 },
                        { url: keyUrl1, width: keyWidth1, height: keyHeight1 },
                        { url: keyUrl2, width: keyWidth2, height: keyHeight2 },
                        { url: keyUrl3, width: keyWidth3, height: keyHeight3 },
                        { url: keyUrl4, width: keyWidth4, height: keyHeight4 },
                    ].filter(x => x.url.includes('://'))
                };
                this.changeImage(image, alt);
            }
        });
    }
    changeImage(image, alt) {
        const smallerImage = image.compressedUrls.find((elem) => {
            return elem.height == '400' || elem.width == '400';
        });
        image.thumbnailUrl = smallerImage?.url ?? image.thumbnailUrl;
        this.storedImage.set(image);
        this.storedAlt.set(alt);
    }
    static { this.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "17.3.10", ngImport: i0, type: DyPictureComponent, deps: [{ token: i1.TranslationClientService }, { token: i2.ImageUploadService }], target: i0.ɵɵFactoryTarget.Component }); }
    static { this.ɵcmp = i0.ɵɵngDeclareComponent({ minVersion: "17.1.0", version: "17.3.10", type: DyPictureComponent, isStandalone: true, selector: "lib-dy-picture", inputs: { originalSrc: { classPropertyName: "originalSrc", publicName: "originalSrc", isSignal: true, isRequired: true, transformFunction: null }, originalAlt: { classPropertyName: "originalAlt", publicName: "originalAlt", isSignal: true, isRequired: true, transformFunction: null }, key: { classPropertyName: "key", publicName: "key", isSignal: true, isRequired: true, transformFunction: null }, imgClass: { classPropertyName: "imgClass", publicName: "imgClass", isSignal: true, isRequired: false, transformFunction: null }, lazy: { classPropertyName: "lazy", publicName: "lazy", isSignal: true, isRequired: false, transformFunction: null }, proportion: { classPropertyName: "proportion", publicName: "proportion", isSignal: true, isRequired: false, transformFunction: null } }, host: { listeners: { "click": "onKeyup()" } }, ngImport: i0, template: "<dy-img [class.dy-border]=\"editMode()\" [alt]=\"altToDisplay()\" [attr.loading]=\"lazy() ? 'lazy' : 'eager'\" [image]=\"imageToDisplay()\"\n        [imgClass]=\"imgClass()\" [sizeRatio]=\"proportion()\"></dy-img>\n", styles: [".dy-border{display:block;height:fit-content;border:4px dashed rgb(169,169,169)}\n"], dependencies: [{ kind: "component", type: DyImgComponent, selector: "dy-img", inputs: ["imgClass", "imgStyle", "image", "alt", "transitionName", "sizeRatio", "height", "width"], outputs: ["heightChange", "widthChange"] }] }); }
}
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "17.3.10", ngImport: i0, type: DyPictureComponent, decorators: [{
            type: Component,
            args: [{ selector: 'lib-dy-picture', standalone: true, imports: [
                        DyImgComponent
                    ], template: "<dy-img [class.dy-border]=\"editMode()\" [alt]=\"altToDisplay()\" [attr.loading]=\"lazy() ? 'lazy' : 'eager'\" [image]=\"imageToDisplay()\"\n        [imgClass]=\"imgClass()\" [sizeRatio]=\"proportion()\"></dy-img>\n", styles: [".dy-border{display:block;height:fit-content;border:4px dashed rgb(169,169,169)}\n"] }]
        }], ctorParameters: () => [{ type: i1.TranslationClientService }, { type: i2.ImageUploadService }], propDecorators: { onKeyup: [{
                type: HostListener,
                args: ['click']
            }] } });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZHktcGljdHVyZS5jb21wb25lbnQuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi8uLi8uLi8uLi9wcm9qZWN0cy9jdXN0b20tZGlzcGxheS9zcmMvbGliL2NvbXBvbmVudHMvaW1hZ2VzL2R5LXBpY3R1cmUvZHktcGljdHVyZS5jb21wb25lbnQudHMiLCIuLi8uLi8uLi8uLi8uLi8uLi8uLi9wcm9qZWN0cy9jdXN0b20tZGlzcGxheS9zcmMvbGliL2NvbXBvbmVudHMvaW1hZ2VzL2R5LXBpY3R1cmUvZHktcGljdHVyZS5jb21wb25lbnQuaHRtbCJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBRUwsU0FBUyxFQUNULFFBQVEsRUFFUixZQUFZLEVBQ1osS0FBSyxFQUdMLE1BQU0sRUFJUCxNQUFNLGVBQWUsQ0FBQztBQUV2QixPQUFPLEVBQUMsR0FBRyxFQUFDLE1BQU0sTUFBTSxDQUFDO0FBR3pCLE9BQU8sRUFBQyxjQUFjLEVBQUMsTUFBTSxnQ0FBZ0MsQ0FBQzs7OztBQVc5RCxNQUFNLE9BQU8sa0JBQWtCO0lBa0I3QixZQUFvQixhQUF1QyxFQUFVLGtCQUFzQztRQUF2RixrQkFBYSxHQUFiLGFBQWEsQ0FBMEI7UUFBVSx1QkFBa0IsR0FBbEIsa0JBQWtCLENBQW9CO1FBakJsRyxnQkFBVyxHQUF3QixLQUFLLENBQUMsUUFBUSxFQUFVLENBQUM7UUFDNUQsZ0JBQVcsR0FBd0IsS0FBSyxDQUFDLFFBQVEsRUFBVSxDQUFDO1FBQzVELFFBQUcsR0FBd0IsS0FBSyxDQUFDLFFBQVEsRUFBVSxDQUFDO1FBQ3BELGFBQVEsR0FBd0IsS0FBSyxDQUFTLEVBQUUsQ0FBQyxDQUFDO1FBQ2xELFNBQUksR0FBeUIsS0FBSyxDQUFVLEtBQUssQ0FBQyxDQUFDO1FBQ25ELGVBQVUsR0FBd0IsS0FBSyxDQUFTLEdBQUcsQ0FBQyxDQUFDO1FBRTdDLGdCQUFXLEdBQW9ELE1BQU0sQ0FBQyxTQUFTLENBQUMsQ0FBQTtRQUN4RixtQkFBYyxHQUFnQyxRQUFRLENBQUMsR0FBRyxFQUFFO1lBQ25FLE9BQU8sSUFBSSxDQUFDLFdBQVcsRUFBRSxJQUFJLEVBQUMsV0FBVyxFQUFFLElBQUksQ0FBQyxXQUFXLEVBQUUsRUFBRSxZQUFZLEVBQUUsSUFBSSxDQUFDLFdBQVcsRUFBRSxFQUFFLGNBQWMsRUFBRSxFQUFFLEVBQUMsQ0FBQTtRQUN0SCxDQUFDLENBQUMsQ0FBQTtRQUNlLGNBQVMsR0FBdUMsTUFBTSxDQUFDLFNBQVMsQ0FBQyxDQUFBO1FBQ3pFLGlCQUFZLEdBQW1CLFFBQVEsQ0FBQyxHQUFHLEVBQUU7WUFDcEQsT0FBTyxJQUFJLENBQUMsU0FBUyxFQUFFLElBQUksSUFBSSxDQUFDLFdBQVcsRUFBRSxDQUFBO1FBQy9DLENBQUMsQ0FBQyxDQUFBO1FBQ0YsYUFBUSxHQUFHLE1BQU0sQ0FBQyxLQUFLLENBQUMsQ0FBQztJQUd6QixDQUFDO0lBRUQsZUFBZTtRQUNiLElBQUksQ0FBQyxhQUFhLENBQUMsV0FBVyxDQUFDLFNBQVMsQ0FBQyxRQUFRLENBQUMsRUFBRTtZQUNsRCxJQUFJLENBQUMsUUFBUSxDQUFDLEdBQUcsQ0FBQyxRQUFRLENBQUMsQ0FBQztRQUM5QixDQUFDLENBQUMsQ0FBQTtJQUNKLENBQUM7SUFHTSxPQUFPO1FBQ1osSUFBSSxJQUFJLENBQUMsUUFBUSxFQUFFLEVBQUU7WUFDbkIsSUFBSSxDQUFDLGtCQUFrQixDQUFDLFVBQVUsRUFBRSxDQUFDLFNBQVMsQ0FBQyxHQUFHLENBQUMsRUFBRTtnQkFDbkQsSUFBSSxDQUFDLFdBQVcsQ0FBQyxHQUFHLENBQUMsSUFBSSxFQUFFLEdBQUcsQ0FBQyxHQUFHLENBQUMsQ0FBQTtnQkFDbkMsSUFBSSxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsSUFBSSxFQUFFLEdBQUcsQ0FBQyxHQUFHLENBQUMsQ0FBQTtZQUM5QixDQUFDLENBQUMsQ0FBQTtTQUNIO0lBQ0gsQ0FBQztJQUVELElBQUksQ0FBQyxRQUE2QixFQUFFLEdBQVc7UUFDN0MsSUFBSSxRQUFRLElBQUksR0FBRyxFQUFFO1lBQ25CLElBQUksQ0FBQyxhQUFhLENBQUMsSUFBSSxDQUFDLFNBQVMsR0FBRyxJQUFJLENBQUMsR0FBRyxFQUFFLEdBQUcsY0FBYyxFQUFFLFFBQVEsQ0FBQyxXQUFXLENBQUMsQ0FBQTtZQUN0RixJQUFJLENBQUMsYUFBYSxDQUFDLElBQUksQ0FBQyxTQUFTLEdBQUcsSUFBSSxDQUFDLEdBQUcsRUFBRSxHQUFHLGVBQWUsRUFBRSxRQUFRLENBQUMsWUFBWSxDQUFDLENBQUE7WUFDeEYsUUFBUSxDQUFDLGNBQWMsQ0FBQyxPQUFPLENBQUMsQ0FBQyxhQUFhLEVBQUUsS0FBSyxFQUFFLEVBQUU7Z0JBQ3ZELElBQUksQ0FBQyxhQUFhLENBQUMsSUFBSSxDQUFDLFNBQVMsR0FBRyxJQUFJLENBQUMsR0FBRyxFQUFFLEdBQUcsY0FBYyxHQUFHLEtBQUssR0FBRyxNQUFNLEVBQUUsYUFBYSxDQUFDLEdBQUcsQ0FBQyxDQUFBO2dCQUNwRyxJQUFJLENBQUMsYUFBYSxDQUFDLElBQUksQ0FBQyxTQUFTLEdBQUcsSUFBSSxDQUFDLEdBQUcsRUFBRSxHQUFHLGNBQWMsR0FBRyxLQUFLLEdBQUcsU0FBUyxFQUFFLGFBQWEsQ0FBQyxNQUFNLENBQUMsQ0FBQTtnQkFDMUcsSUFBSSxDQUFDLGFBQWEsQ0FBQyxJQUFJLENBQUMsU0FBUyxHQUFHLElBQUksQ0FBQyxHQUFHLEVBQUUsR0FBRyxjQUFjLEdBQUcsS0FBSyxHQUFHLFFBQVEsRUFBRSxhQUFhLENBQUMsS0FBSyxDQUFDLENBQUE7WUFDMUcsQ0FBQyxDQUFDLENBQUE7WUFDRixJQUFJLENBQUMsYUFBYSxDQUFDLElBQUksQ0FBQyxTQUFTLEdBQUcsSUFBSSxDQUFDLEdBQUcsRUFBRSxHQUFHLE1BQU0sRUFBRSxHQUFHLENBQUMsQ0FBQTtTQUM5RDtJQUNILENBQUM7SUFFRCxRQUFRO1FBRU4sTUFBTSxNQUFNLEdBQUcsU0FBUyxHQUFHLElBQUksQ0FBQyxHQUFHLEVBQUUsR0FBRyxjQUFjLENBQUE7UUFDdEQsTUFBTSxNQUFNLEdBQUcsU0FBUyxHQUFHLElBQUksQ0FBQyxHQUFHLEVBQUUsR0FBRyxNQUFNLENBQUE7UUFFOUMsTUFBTSxLQUFLLEdBQUcsSUFBSSxDQUFDLGFBQWEsQ0FBQyxpQkFBaUIsQ0FBQyxNQUFNLENBQUMsQ0FBQztRQUMzRCxNQUFNLEtBQUssR0FBRyxJQUFJLENBQUMsYUFBYSxDQUFDLGlCQUFpQixDQUFDLE1BQU0sQ0FBQyxDQUFDO1FBQzNELHdJQUF3STtRQUN4SSxNQUFNLFFBQVEsR0FBRyxJQUFJLENBQUMsYUFBYSxDQUFDLGlCQUFpQixDQUFDLFNBQVMsR0FBRyxJQUFJLENBQUMsR0FBRyxFQUFFLEdBQUcsbUJBQW1CLENBQUMsQ0FBQztRQUNwRyxNQUFNLFdBQVcsR0FBRyxJQUFJLENBQUMsYUFBYSxDQUFDLGlCQUFpQixDQUFDLFNBQVMsR0FBRyxJQUFJLENBQUMsR0FBRyxFQUFFLEdBQUcsc0JBQXNCLENBQUMsQ0FBQztRQUMxRyxNQUFNLFVBQVUsR0FBRyxJQUFJLENBQUMsYUFBYSxDQUFDLGlCQUFpQixDQUFDLFNBQVMsR0FBRyxJQUFJLENBQUMsR0FBRyxFQUFFLEdBQUcscUJBQXFCLENBQUMsQ0FBQztRQUN4RyxNQUFNLFFBQVEsR0FBRyxJQUFJLENBQUMsYUFBYSxDQUFDLGlCQUFpQixDQUFDLFNBQVMsR0FBRyxJQUFJLENBQUMsR0FBRyxFQUFFLEdBQUcsbUJBQW1CLENBQUMsQ0FBQztRQUNwRyxNQUFNLFdBQVcsR0FBRyxJQUFJLENBQUMsYUFBYSxDQUFDLGlCQUFpQixDQUFDLFNBQVMsR0FBRyxJQUFJLENBQUMsR0FBRyxFQUFFLEdBQUcsc0JBQXNCLENBQUMsQ0FBQztRQUMxRyxNQUFNLFVBQVUsR0FBRyxJQUFJLENBQUMsYUFBYSxDQUFDLGlCQUFpQixDQUFDLFNBQVMsR0FBRyxJQUFJLENBQUMsR0FBRyxFQUFFLEdBQUcscUJBQXFCLENBQUMsQ0FBQztRQUN4RyxNQUFNLFFBQVEsR0FBRyxJQUFJLENBQUMsYUFBYSxDQUFDLGlCQUFpQixDQUFDLFNBQVMsR0FBRyxJQUFJLENBQUMsR0FBRyxFQUFFLEdBQUcsbUJBQW1CLENBQUMsQ0FBQztRQUNwRyxNQUFNLFdBQVcsR0FBRyxJQUFJLENBQUMsYUFBYSxDQUFDLGlCQUFpQixDQUFDLFNBQVMsR0FBRyxJQUFJLENBQUMsR0FBRyxFQUFFLEdBQUcsc0JBQXNCLENBQUMsQ0FBQztRQUMxRyxNQUFNLFVBQVUsR0FBRyxJQUFJLENBQUMsYUFBYSxDQUFDLGlCQUFpQixDQUFDLFNBQVMsR0FBRyxJQUFJLENBQUMsR0FBRyxFQUFFLEdBQUcscUJBQXFCLENBQUMsQ0FBQztRQUN4RyxNQUFNLFFBQVEsR0FBRyxJQUFJLENBQUMsYUFBYSxDQUFDLGlCQUFpQixDQUFDLFNBQVMsR0FBRyxJQUFJLENBQUMsR0FBRyxFQUFFLEdBQUcsbUJBQW1CLENBQUMsQ0FBQztRQUNwRyxNQUFNLFdBQVcsR0FBRyxJQUFJLENBQUMsYUFBYSxDQUFDLGlCQUFpQixDQUFDLFNBQVMsR0FBRyxJQUFJLENBQUMsR0FBRyxFQUFFLEdBQUcsc0JBQXNCLENBQUMsQ0FBQztRQUMxRyxNQUFNLFVBQVUsR0FBRyxJQUFJLENBQUMsYUFBYSxDQUFDLGlCQUFpQixDQUFDLFNBQVMsR0FBRyxJQUFJLENBQUMsR0FBRyxFQUFFLEdBQUcscUJBQXFCLENBQUMsQ0FBQztRQUN4RyxNQUFNLFFBQVEsR0FBRyxJQUFJLENBQUMsYUFBYSxDQUFDLGlCQUFpQixDQUFDLFNBQVMsR0FBRyxJQUFJLENBQUMsR0FBRyxFQUFFLEdBQUcsbUJBQW1CLENBQUMsQ0FBQztRQUNwRyxNQUFNLFdBQVcsR0FBRyxJQUFJLENBQUMsYUFBYSxDQUFDLGlCQUFpQixDQUFDLFNBQVMsR0FBRyxJQUFJLENBQUMsR0FBRyxFQUFFLEdBQUcsc0JBQXNCLENBQUMsQ0FBQztRQUMxRyxNQUFNLFVBQVUsR0FBRyxJQUFJLENBQUMsYUFBYSxDQUFDLGlCQUFpQixDQUFDLFNBQVMsR0FBRyxJQUFJLENBQUMsR0FBRyxFQUFFLEdBQUcscUJBQXFCLENBQUMsQ0FBQztRQUV4RyxHQUFHLENBQUM7WUFDRixLQUFLLEVBQUUsS0FBSztZQUNaLFFBQVEsRUFBRSxXQUFXLEVBQUUsVUFBVSxFQUFFLFFBQVEsRUFBRSxXQUFXLEVBQUUsVUFBVSxFQUFFLFFBQVEsRUFBRSxXQUFXLEVBQUUsVUFBVSxFQUFFLFFBQVEsRUFBRSxXQUFXLEVBQUUsVUFBVSxFQUFFLFFBQVEsRUFBRSxXQUFXLEVBQUUsVUFBVTtTQUU5SyxDQUFDLENBQUMsU0FBUyxDQUFDLENBQUMsQ0FBQyxHQUFHLEVBQUUsR0FBRyxFQUNQLE9BQU8sRUFDUCxVQUFVLEVBQ1YsU0FBUyxFQUNULE9BQU8sRUFDUCxVQUFVLEVBQ1YsU0FBUyxFQUNULE9BQU8sRUFDUCxVQUFVLEVBQ1YsU0FBUyxFQUNULE9BQU8sRUFDUCxVQUFVLEVBQ1YsU0FBUyxFQUNULE9BQU8sRUFDUCxVQUFVLEVBQ1YsU0FBUyxDQUNWLEVBQUUsRUFBRTtZQUNqQixJQUFJLE1BQU0sSUFBSSxHQUFHLElBQUksTUFBTSxJQUFJLEdBQUcsRUFBRTtnQkFDbEMsTUFBTSxLQUFLLEdBQXdCO29CQUNqQyxXQUFXLEVBQUUsR0FBRyxFQUFFLFlBQVksRUFBRSxHQUFHLEVBQUUsY0FBYyxFQUFFO3dCQUNuRCxFQUFDLEdBQUcsRUFBRSxPQUFPLEVBQUUsS0FBSyxFQUFFLFNBQVMsRUFBRSxNQUFNLEVBQUUsVUFBVSxFQUFDO3dCQUNwRCxFQUFDLEdBQUcsRUFBRSxPQUFPLEVBQUUsS0FBSyxFQUFFLFNBQVMsRUFBRSxNQUFNLEVBQUUsVUFBVSxFQUFDO3dCQUNwRCxFQUFDLEdBQUcsRUFBRSxPQUFPLEVBQUUsS0FBSyxFQUFFLFNBQVMsRUFBRSxNQUFNLEVBQUUsVUFBVSxFQUFDO3dCQUNwRCxFQUFDLEdBQUcsRUFBRSxPQUFPLEVBQUUsS0FBSyxFQUFFLFNBQVMsRUFBRSxNQUFNLEVBQUUsVUFBVSxFQUFDO3dCQUNwRCxFQUFDLEdBQUcsRUFBRSxPQUFPLEVBQUUsS0FBSyxFQUFFLFNBQVMsRUFBRSxNQUFNLEVBQUUsVUFBVSxFQUFDO3FCQUNyRCxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQyxHQUFHLENBQUMsUUFBUSxDQUFDLEtBQUssQ0FBQyxDQUFDO2lCQUNyQyxDQUFBO2dCQUNELElBQUksQ0FBQyxXQUFXLENBQUMsS0FBSyxFQUFFLEdBQUcsQ0FBQyxDQUFBO2FBQzdCO1FBQ0gsQ0FBQyxDQUFDLENBQUE7SUFDSixDQUFDO0lBRUQsV0FBVyxDQUFDLEtBQTBCLEVBQUUsR0FBVztRQUNqRCxNQUFNLFlBQVksR0FBRyxLQUFLLENBQUMsY0FBYyxDQUFDLElBQUksQ0FBQyxDQUFDLElBQUksRUFBRSxFQUFFO1lBQ3RELE9BQU8sSUFBSSxDQUFDLE1BQU0sSUFBSSxLQUFLLElBQUksSUFBSSxDQUFDLEtBQUssSUFBSSxLQUFLLENBQUE7UUFDcEQsQ0FBQyxDQUFDLENBQUE7UUFDRixLQUFLLENBQUMsWUFBWSxHQUFHLFlBQVksRUFBRSxHQUFHLElBQUksS0FBSyxDQUFDLFlBQVksQ0FBQTtRQUU1RCxJQUFJLENBQUMsV0FBVyxDQUFDLEdBQUcsQ0FBQyxLQUFLLENBQUMsQ0FBQTtRQUMzQixJQUFJLENBQUMsU0FBUyxDQUFDLEdBQUcsQ0FBQyxHQUFHLENBQUMsQ0FBQTtJQUN6QixDQUFDOytHQXRIVSxrQkFBa0I7bUdBQWxCLGtCQUFrQixxNEJDN0IvQix5TkFFQSwySURzQkksY0FBYzs7NEZBS0wsa0JBQWtCO2tCQVQ5QixTQUFTOytCQUNFLGdCQUFnQixjQUNkLElBQUksV0FDUDt3QkFDUCxjQUFjO3FCQUNmOzhIQWdDTSxPQUFPO3NCQURiLFlBQVk7dUJBQUMsT0FBTyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7XG4gIEFmdGVyVmlld0luaXQsXG4gIENvbXBvbmVudCxcbiAgY29tcHV0ZWQsXG4gIEVsZW1lbnRSZWYsXG4gIEhvc3RMaXN0ZW5lcixcbiAgaW5wdXQsXG4gIElucHV0U2lnbmFsLFxuICBPbkluaXQsXG4gIHNpZ25hbCxcbiAgU2lnbmFsLFxuICBWaWV3Q2hpbGQsXG4gIFdyaXRhYmxlU2lnbmFsXG59IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xuaW1wb3J0IHtVcGxvYWRJbWFnZVJlc3BvbnNlfSBmcm9tIFwiLi4vLi4vLi4vbW9kZWwvaW1hZ2VzL3VwbG9hZC1pbWFnZS1yZXNwb25zZVwiO1xuaW1wb3J0IHt6aXB9IGZyb20gXCJyeGpzXCI7XG5pbXBvcnQge1RyYW5zbGF0aW9uQ2xpZW50U2VydmljZX0gZnJvbSBcIi4uLy4uLy4uL3NlcnZpY2UvdHJhbnNsYXRlL3RyYW5zbGF0aW9uLWNsaWVudC5zZXJ2aWNlXCI7XG5pbXBvcnQge0ltYWdlVXBsb2FkU2VydmljZX0gZnJvbSBcIi4uLy4uLy4uL3NlcnZpY2UvaW1hZ2UtdXBsb2FkL2ltYWdlLXVwbG9hZC5zZXJ2aWNlXCI7XG5pbXBvcnQge0R5SW1nQ29tcG9uZW50fSBmcm9tIFwiLi4vdGFnL2R5LWltZy9keS1pbWcuY29tcG9uZW50XCI7XG5cbkBDb21wb25lbnQoe1xuICBzZWxlY3RvcjogJ2xpYi1keS1waWN0dXJlJyxcbiAgc3RhbmRhbG9uZTogdHJ1ZSxcbiAgaW1wb3J0czogW1xuICAgIER5SW1nQ29tcG9uZW50XG4gIF0sXG4gIHRlbXBsYXRlVXJsOiAnLi9keS1waWN0dXJlLmNvbXBvbmVudC5odG1sJyxcbiAgc3R5bGVVcmw6ICcuL2R5LXBpY3R1cmUuY29tcG9uZW50LmNzcydcbn0pXG5leHBvcnQgY2xhc3MgRHlQaWN0dXJlQ29tcG9uZW50IGltcGxlbWVudHMgT25Jbml0LCBBZnRlclZpZXdJbml0IHtcbiAgcmVhZG9ubHkgb3JpZ2luYWxTcmM6IElucHV0U2lnbmFsPHN0cmluZz4gPSBpbnB1dC5yZXF1aXJlZDxzdHJpbmc+KCk7XG4gIHJlYWRvbmx5IG9yaWdpbmFsQWx0OiBJbnB1dFNpZ25hbDxzdHJpbmc+ID0gaW5wdXQucmVxdWlyZWQ8c3RyaW5nPigpO1xuICByZWFkb25seSBrZXk6IElucHV0U2lnbmFsPHN0cmluZz4gPSBpbnB1dC5yZXF1aXJlZDxzdHJpbmc+KCk7XG4gIHJlYWRvbmx5IGltZ0NsYXNzOiBJbnB1dFNpZ25hbDxzdHJpbmc+ID0gaW5wdXQ8c3RyaW5nPignJyk7XG4gIHJlYWRvbmx5IGxhenk6IElucHV0U2lnbmFsPGJvb2xlYW4+ID0gaW5wdXQ8Ym9vbGVhbj4oZmFsc2UpO1xuICByZWFkb25seSBwcm9wb3J0aW9uOiBJbnB1dFNpZ25hbDxudW1iZXI+ID0gaW5wdXQ8bnVtYmVyPigxMDApO1xuXG4gIHByaXZhdGUgcmVhZG9ubHkgc3RvcmVkSW1hZ2U6IFdyaXRhYmxlU2lnbmFsPFVwbG9hZEltYWdlUmVzcG9uc2UgfCB1bmRlZmluZWQ+ID0gc2lnbmFsKHVuZGVmaW5lZClcbiAgcmVhZG9ubHkgaW1hZ2VUb0Rpc3BsYXk6IFNpZ25hbDxVcGxvYWRJbWFnZVJlc3BvbnNlPiA9IGNvbXB1dGVkKCgpID0+IHtcbiAgICByZXR1cm4gdGhpcy5zdG9yZWRJbWFnZSgpID8/IHtvcmlnaW5hbFVybDogdGhpcy5vcmlnaW5hbFNyYygpLCB0aHVtYm5haWxVcmw6IHRoaXMub3JpZ2luYWxTcmMoKSwgY29tcHJlc3NlZFVybHM6IFtdfVxuICB9KVxuICBwcml2YXRlIHJlYWRvbmx5IHN0b3JlZEFsdDogV3JpdGFibGVTaWduYWw8c3RyaW5nIHwgdW5kZWZpbmVkPiA9IHNpZ25hbCh1bmRlZmluZWQpXG4gIHJlYWRvbmx5IGFsdFRvRGlzcGxheTogU2lnbmFsPHN0cmluZz4gPSBjb21wdXRlZCgoKSA9PiB7XG4gICAgcmV0dXJuIHRoaXMuc3RvcmVkQWx0KCkgPz8gdGhpcy5vcmlnaW5hbEFsdCgpXG4gIH0pXG4gIGVkaXRNb2RlID0gc2lnbmFsKGZhbHNlKTtcblxuICBjb25zdHJ1Y3Rvcihwcml2YXRlIGNsaWVudFNlcnZpY2U6IFRyYW5zbGF0aW9uQ2xpZW50U2VydmljZSwgcHJpdmF0ZSBpbWFnZVVwbG9hZFNlcnZpY2U6IEltYWdlVXBsb2FkU2VydmljZSkge1xuICB9XG5cbiAgbmdBZnRlclZpZXdJbml0KCk6IHZvaWQge1xuICAgIHRoaXMuY2xpZW50U2VydmljZS5lZGl0U3ViamVjdC5zdWJzY3JpYmUoZWRpdE1vZGUgPT4ge1xuICAgICAgdGhpcy5lZGl0TW9kZS5zZXQoZWRpdE1vZGUpO1xuICAgIH0pXG4gIH1cblxuICBASG9zdExpc3RlbmVyKCdjbGljaycpXG4gIHB1YmxpYyBvbktleXVwKCk6IHZvaWQge1xuICAgIGlmICh0aGlzLmVkaXRNb2RlKCkpIHtcbiAgICAgIHRoaXMuaW1hZ2VVcGxvYWRTZXJ2aWNlLm9wZW5EaWFsb2coKS5zdWJzY3JpYmUocmVzID0+IHtcbiAgICAgICAgdGhpcy5jaGFuZ2VJbWFnZShyZXMudXJscywgcmVzLmFsdClcbiAgICAgICAgdGhpcy5zYXZlKHJlcy51cmxzLCByZXMuYWx0KVxuICAgICAgfSlcbiAgICB9XG4gIH1cblxuICBzYXZlKHJlc3BvbnNlOiBVcGxvYWRJbWFnZVJlc3BvbnNlLCBhbHQ6IHN0cmluZykge1xuICAgIGlmIChyZXNwb25zZSAmJiBhbHQpIHtcbiAgICAgIHRoaXMuY2xpZW50U2VydmljZS5uZXh0KCdpbWFnZXMuJyArIHRoaXMua2V5KCkgKyAnLm9yaWdpbmFsVXJsJywgcmVzcG9uc2Uub3JpZ2luYWxVcmwpXG4gICAgICB0aGlzLmNsaWVudFNlcnZpY2UubmV4dCgnaW1hZ2VzLicgKyB0aGlzLmtleSgpICsgJy50aHVtYm5haWxVcmwnLCByZXNwb25zZS50aHVtYm5haWxVcmwpXG4gICAgICByZXNwb25zZS5jb21wcmVzc2VkVXJscy5mb3JFYWNoKChjb21wcmVzc2VkVXJsLCBpbmRleCkgPT4ge1xuICAgICAgICB0aGlzLmNsaWVudFNlcnZpY2UubmV4dCgnaW1hZ2VzLicgKyB0aGlzLmtleSgpICsgJy5jb21wcmVzc2VkLScgKyBpbmRleCArICcudXJsJywgY29tcHJlc3NlZFVybC51cmwpXG4gICAgICAgIHRoaXMuY2xpZW50U2VydmljZS5uZXh0KCdpbWFnZXMuJyArIHRoaXMua2V5KCkgKyAnLmNvbXByZXNzZWQtJyArIGluZGV4ICsgJy5oZWlnaHQnLCBjb21wcmVzc2VkVXJsLmhlaWdodClcbiAgICAgICAgdGhpcy5jbGllbnRTZXJ2aWNlLm5leHQoJ2ltYWdlcy4nICsgdGhpcy5rZXkoKSArICcuY29tcHJlc3NlZC0nICsgaW5kZXggKyAnLndpZHRoJywgY29tcHJlc3NlZFVybC53aWR0aClcbiAgICAgIH0pXG4gICAgICB0aGlzLmNsaWVudFNlcnZpY2UubmV4dCgnaW1hZ2VzLicgKyB0aGlzLmtleSgpICsgJy5hbHQnLCBhbHQpXG4gICAgfVxuICB9XG5cbiAgbmdPbkluaXQoKTogdm9pZCB7XG5cbiAgICBjb25zdCB1cmxLZXkgPSAnaW1hZ2VzLicgKyB0aGlzLmtleSgpICsgJy5vcmlnaW5hbFVybCdcbiAgICBjb25zdCBhbHRLZXkgPSAnaW1hZ2VzLicgKyB0aGlzLmtleSgpICsgJy5hbHQnXG5cbiAgICBjb25zdCBrZXkxJCA9IHRoaXMuY2xpZW50U2VydmljZS5zdHJlYW1UcmFuc2xhdGlvbih1cmxLZXkpO1xuICAgIGNvbnN0IGtleTIkID0gdGhpcy5jbGllbnRTZXJ2aWNlLnN0cmVhbVRyYW5zbGF0aW9uKGFsdEtleSk7XG4gICAgLyogKioqIElNUE9SVEFOVCBoZXJlIGlzIHRoZSBudW1iZXIgb2YgZGlmZmVyZW50IGltYWdlIGNvbXByZXNzIHNpemUgcmV0dXJuZWQgYnkgYmFja2VuZCAoNSk6IFwiNDAwXCIsIFwiNjAwXCIsIFwiODAwXCIsIFwiMTAwMFwiLCBcIjEyMDBcIiAqKiogKi9cbiAgICBjb25zdCBrZXlVcmwwJCA9IHRoaXMuY2xpZW50U2VydmljZS5zdHJlYW1UcmFuc2xhdGlvbignaW1hZ2VzLicgKyB0aGlzLmtleSgpICsgJy5jb21wcmVzc2VkLTAudXJsJyk7XG4gICAgY29uc3Qga2V5SGVpZ2h0MCQgPSB0aGlzLmNsaWVudFNlcnZpY2Uuc3RyZWFtVHJhbnNsYXRpb24oJ2ltYWdlcy4nICsgdGhpcy5rZXkoKSArICcuY29tcHJlc3NlZC0wLmhlaWdodCcpO1xuICAgIGNvbnN0IGtleVdpZHRoMCQgPSB0aGlzLmNsaWVudFNlcnZpY2Uuc3RyZWFtVHJhbnNsYXRpb24oJ2ltYWdlcy4nICsgdGhpcy5rZXkoKSArICcuY29tcHJlc3NlZC0wLndpZHRoJyk7XG4gICAgY29uc3Qga2V5VXJsMSQgPSB0aGlzLmNsaWVudFNlcnZpY2Uuc3RyZWFtVHJhbnNsYXRpb24oJ2ltYWdlcy4nICsgdGhpcy5rZXkoKSArICcuY29tcHJlc3NlZC0xLnVybCcpO1xuICAgIGNvbnN0IGtleUhlaWdodDEkID0gdGhpcy5jbGllbnRTZXJ2aWNlLnN0cmVhbVRyYW5zbGF0aW9uKCdpbWFnZXMuJyArIHRoaXMua2V5KCkgKyAnLmNvbXByZXNzZWQtMS5oZWlnaHQnKTtcbiAgICBjb25zdCBrZXlXaWR0aDEkID0gdGhpcy5jbGllbnRTZXJ2aWNlLnN0cmVhbVRyYW5zbGF0aW9uKCdpbWFnZXMuJyArIHRoaXMua2V5KCkgKyAnLmNvbXByZXNzZWQtMS53aWR0aCcpO1xuICAgIGNvbnN0IGtleVVybDIkID0gdGhpcy5jbGllbnRTZXJ2aWNlLnN0cmVhbVRyYW5zbGF0aW9uKCdpbWFnZXMuJyArIHRoaXMua2V5KCkgKyAnLmNvbXByZXNzZWQtMi51cmwnKTtcbiAgICBjb25zdCBrZXlIZWlnaHQyJCA9IHRoaXMuY2xpZW50U2VydmljZS5zdHJlYW1UcmFuc2xhdGlvbignaW1hZ2VzLicgKyB0aGlzLmtleSgpICsgJy5jb21wcmVzc2VkLTIuaGVpZ2h0Jyk7XG4gICAgY29uc3Qga2V5V2lkdGgyJCA9IHRoaXMuY2xpZW50U2VydmljZS5zdHJlYW1UcmFuc2xhdGlvbignaW1hZ2VzLicgKyB0aGlzLmtleSgpICsgJy5jb21wcmVzc2VkLTIud2lkdGgnKTtcbiAgICBjb25zdCBrZXlVcmwzJCA9IHRoaXMuY2xpZW50U2VydmljZS5zdHJlYW1UcmFuc2xhdGlvbignaW1hZ2VzLicgKyB0aGlzLmtleSgpICsgJy5jb21wcmVzc2VkLTMudXJsJyk7XG4gICAgY29uc3Qga2V5SGVpZ2h0MyQgPSB0aGlzLmNsaWVudFNlcnZpY2Uuc3RyZWFtVHJhbnNsYXRpb24oJ2ltYWdlcy4nICsgdGhpcy5rZXkoKSArICcuY29tcHJlc3NlZC0zLmhlaWdodCcpO1xuICAgIGNvbnN0IGtleVdpZHRoMyQgPSB0aGlzLmNsaWVudFNlcnZpY2Uuc3RyZWFtVHJhbnNsYXRpb24oJ2ltYWdlcy4nICsgdGhpcy5rZXkoKSArICcuY29tcHJlc3NlZC0zLndpZHRoJyk7XG4gICAgY29uc3Qga2V5VXJsNCQgPSB0aGlzLmNsaWVudFNlcnZpY2Uuc3RyZWFtVHJhbnNsYXRpb24oJ2ltYWdlcy4nICsgdGhpcy5rZXkoKSArICcuY29tcHJlc3NlZC00LnVybCcpO1xuICAgIGNvbnN0IGtleUhlaWdodDQkID0gdGhpcy5jbGllbnRTZXJ2aWNlLnN0cmVhbVRyYW5zbGF0aW9uKCdpbWFnZXMuJyArIHRoaXMua2V5KCkgKyAnLmNvbXByZXNzZWQtNC5oZWlnaHQnKTtcbiAgICBjb25zdCBrZXlXaWR0aDQkID0gdGhpcy5jbGllbnRTZXJ2aWNlLnN0cmVhbVRyYW5zbGF0aW9uKCdpbWFnZXMuJyArIHRoaXMua2V5KCkgKyAnLmNvbXByZXNzZWQtNC53aWR0aCcpO1xuXG4gICAgemlwKFtcbiAgICAgIGtleTEkLCBrZXkyJCxcbiAgICAgIGtleVVybDAkLCBrZXlIZWlnaHQwJCwga2V5V2lkdGgwJCwga2V5VXJsMSQsIGtleUhlaWdodDEkLCBrZXlXaWR0aDEkLCBrZXlVcmwyJCwga2V5SGVpZ2h0MiQsIGtleVdpZHRoMiQsIGtleVVybDMkLCBrZXlIZWlnaHQzJCwga2V5V2lkdGgzJCwga2V5VXJsNCQsIGtleUhlaWdodDQkLCBrZXlXaWR0aDQkXG5cbiAgICBdKS5zdWJzY3JpYmUoKFt1cmwsIGFsdCxcbiAgICAgICAgICAgICAgICAgICAga2V5VXJsMCxcbiAgICAgICAgICAgICAgICAgICAga2V5SGVpZ2h0MCxcbiAgICAgICAgICAgICAgICAgICAga2V5V2lkdGgwLFxuICAgICAgICAgICAgICAgICAgICBrZXlVcmwxLFxuICAgICAgICAgICAgICAgICAgICBrZXlIZWlnaHQxLFxuICAgICAgICAgICAgICAgICAgICBrZXlXaWR0aDEsXG4gICAgICAgICAgICAgICAgICAgIGtleVVybDIsXG4gICAgICAgICAgICAgICAgICAgIGtleUhlaWdodDIsXG4gICAgICAgICAgICAgICAgICAgIGtleVdpZHRoMixcbiAgICAgICAgICAgICAgICAgICAga2V5VXJsMyxcbiAgICAgICAgICAgICAgICAgICAga2V5SGVpZ2h0MyxcbiAgICAgICAgICAgICAgICAgICAga2V5V2lkdGgzLFxuICAgICAgICAgICAgICAgICAgICBrZXlVcmw0LFxuICAgICAgICAgICAgICAgICAgICBrZXlIZWlnaHQ0LFxuICAgICAgICAgICAgICAgICAgICBrZXlXaWR0aDRcbiAgICAgICAgICAgICAgICAgIF0pID0+IHtcbiAgICAgIGlmICh1cmxLZXkgIT0gdXJsIHx8IGFsdEtleSAhPSBhbHQpIHtcbiAgICAgICAgY29uc3QgaW1hZ2U6IFVwbG9hZEltYWdlUmVzcG9uc2UgPSB7XG4gICAgICAgICAgb3JpZ2luYWxVcmw6IHVybCwgdGh1bWJuYWlsVXJsOiB1cmwsIGNvbXByZXNzZWRVcmxzOiBbXG4gICAgICAgICAgICB7dXJsOiBrZXlVcmwwLCB3aWR0aDoga2V5V2lkdGgwLCBoZWlnaHQ6IGtleUhlaWdodDB9LFxuICAgICAgICAgICAge3VybDoga2V5VXJsMSwgd2lkdGg6IGtleVdpZHRoMSwgaGVpZ2h0OiBrZXlIZWlnaHQxfSxcbiAgICAgICAgICAgIHt1cmw6IGtleVVybDIsIHdpZHRoOiBrZXlXaWR0aDIsIGhlaWdodDoga2V5SGVpZ2h0Mn0sXG4gICAgICAgICAgICB7dXJsOiBrZXlVcmwzLCB3aWR0aDoga2V5V2lkdGgzLCBoZWlnaHQ6IGtleUhlaWdodDN9LFxuICAgICAgICAgICAge3VybDoga2V5VXJsNCwgd2lkdGg6IGtleVdpZHRoNCwgaGVpZ2h0OiBrZXlIZWlnaHQ0fSxcbiAgICAgICAgICBdLmZpbHRlcih4ID0+IHgudXJsLmluY2x1ZGVzKCc6Ly8nKSlcbiAgICAgICAgfVxuICAgICAgICB0aGlzLmNoYW5nZUltYWdlKGltYWdlLCBhbHQpXG4gICAgICB9XG4gICAgfSlcbiAgfVxuXG4gIGNoYW5nZUltYWdlKGltYWdlOiBVcGxvYWRJbWFnZVJlc3BvbnNlLCBhbHQ6IHN0cmluZykge1xuICAgIGNvbnN0IHNtYWxsZXJJbWFnZSA9IGltYWdlLmNvbXByZXNzZWRVcmxzLmZpbmQoKGVsZW0pID0+IHtcbiAgICAgIHJldHVybiBlbGVtLmhlaWdodCA9PSAnNDAwJyB8fCBlbGVtLndpZHRoID09ICc0MDAnXG4gICAgfSlcbiAgICBpbWFnZS50aHVtYm5haWxVcmwgPSBzbWFsbGVySW1hZ2U/LnVybCA/PyBpbWFnZS50aHVtYm5haWxVcmxcblxuICAgIHRoaXMuc3RvcmVkSW1hZ2Uuc2V0KGltYWdlKVxuICAgIHRoaXMuc3RvcmVkQWx0LnNldChhbHQpXG4gIH1cblxufVxuIiwiPGR5LWltZyBbY2xhc3MuZHktYm9yZGVyXT1cImVkaXRNb2RlKClcIiBbYWx0XT1cImFsdFRvRGlzcGxheSgpXCIgW2F0dHIubG9hZGluZ109XCJsYXp5KCkgPyAnbGF6eScgOiAnZWFnZXInXCIgW2ltYWdlXT1cImltYWdlVG9EaXNwbGF5KClcIlxuICAgICAgICBbaW1nQ2xhc3NdPVwiaW1nQ2xhc3MoKVwiIFtzaXplUmF0aW9dPVwicHJvcG9ydGlvbigpXCI+PC9keS1pbWc+XG4iXX0=